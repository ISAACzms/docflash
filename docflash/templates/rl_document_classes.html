<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Classes Dashboard - DocFlash</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', path='style.css') }}" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-md-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2><i class="fas fa-database text-primary"></i> Document Classes Dashboard</h2>
                        <p class="text-muted">Overview of all document classes and their RL performance</p>
                    </div>
                    <a href="/" class="btn btn-outline-primary">
                        <i class="fas fa-home"></i> Back to Main
                    </a>
                </div>

                <!-- Summary Cards -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card bg-primary text-white">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-list fa-2x me-3"></i>
                                    <div>
                                        <h5 class="card-title mb-0" id="totalClasses">-</h5>
                                        <small>Total Classes</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-success text-white">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-template fa-2x me-3"></i>
                                    <div>
                                        <h5 class="card-title mb-0" id="withTemplates">-</h5>
                                        <small>With Templates</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-info text-white">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-comments fa-2x me-3"></i>
                                    <div>
                                        <h5 class="card-title mb-0" id="totalFeedback">-</h5>
                                        <small>Total Feedback</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-warning text-white">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-brain fa-2x me-3"></i>
                                    <div>
                                        <h5 class="card-title mb-0" id="avgSatisfaction">-</h5>
                                        <small>Avg Satisfaction</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Document Classes Table -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-table"></i> Document Classes
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="documentClassesTable">
                                <thead>
                                    <tr>
                                        <th>Document Class</th>
                                        <th>Template</th>
                                        <th>Feedback</th>
                                        <th>Positive</th>
                                        <th>Negative</th>
                                        <th>Satisfaction</th>
                                        <th>Avg Rating</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="classesTableBody">
                                    <tr>
                                        <td colspan="8" class="text-center">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="card mt-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-cog"></i> Actions
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <button class="btn btn-primary w-100" onclick="refreshData()">
                                    <i class="fas fa-sync-alt"></i> Refresh Data
                                </button>
                            </div>
                            <div class="col-md-6">
                                <a href="/rl/dashboard" class="btn btn-outline-primary w-100">
                                    <i class="fas fa-chart-line"></i> RL Dashboard
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let documentClassesData = [];

        async function loadDocumentClasses() {
            try {
                const response = await fetch('/api/document_classes');
                const data = await response.json();
                
                if (data.success) {
                    documentClassesData = data.document_classes;
                    updateSummaryCards(data);
                    renderTable(data.document_classes);
                } else {
                    throw new Error('Failed to load document classes');
                }
            } catch (error) {
                console.error('Error loading document classes:', error);
                document.getElementById('classesTableBody').innerHTML = 
                    '<tr><td colspan="8" class="text-center text-danger">Error loading data</td></tr>';
            }
        }

        function updateSummaryCards(data) {
            document.getElementById('totalClasses').textContent = data.total_classes;
            
            const withTemplates = data.document_classes.filter(cls => cls.has_template).length;
            document.getElementById('withTemplates').textContent = withTemplates;
            
            const totalFeedback = data.document_classes.reduce((sum, cls) => sum + cls.feedback_count, 0);
            document.getElementById('totalFeedback').textContent = totalFeedback;
            
            const avgSatisfaction = data.document_classes.length > 0 ? 
                (data.document_classes.reduce((sum, cls) => sum + cls.satisfaction_rate, 0) / data.document_classes.length * 100).toFixed(1) + '%' : 
                'N/A';
            document.getElementById('avgSatisfaction').textContent = avgSatisfaction;
        }

        function renderTable(classes) {
            const tbody = document.getElementById('classesTableBody');
            
            if (classes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No document classes found</td></tr>';
                return;
            }
            
            tbody.innerHTML = classes.map(cls => `
                <tr>
                    <td>
                        <strong>${cls.document_class}</strong>
                    </td>
                    <td>
                        ${cls.has_template ? 
                            '<span class="badge bg-success">Yes</span>' : 
                            '<span class="badge bg-secondary">No</span>'
                        }
                    </td>
                    <td>
                        <span class="badge bg-primary">${cls.feedback_count}</span>
                    </td>
                    <td>
                        <span class="badge bg-success">${cls.positive_feedback}</span>
                    </td>
                    <td>
                        <span class="badge bg-danger">${cls.negative_feedback}</span>
                    </td>
                    <td>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar bg-success" role="progressbar" 
                                 style="width: ${cls.satisfaction_rate * 100}%" 
                                 aria-valuenow="${cls.satisfaction_rate * 100}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                                ${(cls.satisfaction_rate * 100).toFixed(1)}%
                            </div>
                        </div>
                    </td>
                    <td>
                        ${cls.average_rating ? 
                            `<span class="badge bg-warning">${cls.average_rating.toFixed(1)}/5</span>` : 
                            '<span class="text-muted">N/A</span>'
                        }
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewDetails('${cls.document_class}')">
                            <i class="fas fa-eye"></i> View
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function viewDetails(documentClass) {
            // Redirect to RL dashboard with filter
            window.location.href = `/rl/debug/${encodeURIComponent(documentClass)}`;
        }

        function refreshData() {
            loadDocumentClasses();
        }

        // Load data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadDocumentClasses();
        });
    </script>
</body>
</html>